<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mobx æºç åˆ†æ - shallowBoxã€boxã€ObservableValue | Mobx æºç åˆ†æ</title>
    <meta name="description" content="ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œï¼›ä¸ç§¯å°æµï¼Œæ— ä»¥æˆæ±Ÿæµ·ã€‚">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="shortcut icon" href="/mobx-source-analysis/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/mobx-source-analysis/favicon.ico" type="image/x-icon">
    
    <link rel="preload" href="/mobx-source-analysis/assets/css/0.styles.96e00fc3.css" as="style"><link rel="preload" href="/mobx-source-analysis/assets/js/app.a19a3fb9.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/2.16839f28.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/3.dda6df1c.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/6.0baf6d73.js" as="script"><link rel="prefetch" href="/mobx-source-analysis/assets/js/10.1f8192ef.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/11.1aef4ea1.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/12.619c319d.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/13.bce74719.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/14.d973291b.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/4.0b1e5714.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/5.5824d97a.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/7.16061ce9.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/8.35386181.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/9.8a72fd31.js">
    <link rel="stylesheet" href="/mobx-source-analysis/assets/css/0.styles.96e00fc3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mobx-source-analysis/" class="home-link router-link-active"><!----> <span class="site-name">Mobx æºç åˆ†æ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mobx-source-analysis/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://g-grant.github.io/Note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  åšå®¢
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/G-Grant" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mobx-source-analysis/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://g-grant.github.io/Note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  åšå®¢
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/G-Grant" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mobx æºç åˆ†æ - shallowBoxã€boxã€ObservableValue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mobx-source-analysis/20190822.html#shallowboxã€box" class="sidebar-link">shallowBoxã€box</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mobx-source-analysis/20190822.html#observablevalue" class="sidebar-link">ObservableValue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mobx-source-analysis/20190822.html#æ„é€ å‡½æ•°" class="sidebar-link">æ„é€ å‡½æ•°</a></li><li class="sidebar-sub-header"><a href="/mobx-source-analysis/20190822.html#æ–¹æ³•" class="sidebar-link">æ–¹æ³•</a></li></ul></li><li><a href="/mobx-source-analysis/20190822.html#isobservablevalue" class="sidebar-link">isObservableValue</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mobx-source-analysis/20190822.html#ç»“å°¾è¯­" class="sidebar-link">ç»“å°¾è¯­</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mobx-æºç åˆ†æ-shallowboxã€boxã€observablevalue"><a href="#mobx-æºç åˆ†æ-shallowboxã€boxã€observablevalue" aria-hidden="true" class="header-anchor">#</a> Mobx æºç åˆ†æ - shallowBoxã€boxã€ObservableValue</h1> <p><a href="/mobx-source-analysis/20190822.html" class="router-link-exact-active router-link-active">ä¸Šæ–‡</a>æåˆ°ï¼Œ<code>observable</code> ä¸Šç»‘å®šäº† 13 ä¸ªæ–¹æ³•ã€‚æ­¤ç¯‡æ–‡ç« ä¼šé‡ç‚¹è®²è§£ <code>shallowBox</code> å’Œ <code>box</code>ã€‚</p> <h2 id="shallowboxã€box"><a href="#shallowboxã€box" aria-hidden="true" class="header-anchor">#</a> shallowBoxã€box</h2> <p>å½“è°ƒç”¨ <code>observable.shallowBox</code> æ—¶ï¼Œ<code>mobx</code> ä¼šç»™å‡ºåºŸå¼ƒè­¦å‘Šï¼Œå¹¶å¸®ä½ è½¬æ¢æˆ <code>observable.box</code>ï¼Œåªæ˜¯åœ¨è½¬æ¢çš„æ—¶å€™ï¼Œä¼šç»™ <code>observable.box</code> ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•° <code>{ name, deep: false }</code>ï¼Œè¿™ä¸ªå‚æ•°çš„ä½œç”¨ä¾¿æ˜¯å‘Šè¯‰ <code>observable.box</code> åœ¨å®ä¾‹åŒ– <code>ObservableValue</code> æ—¶ï¼Œä½¿ç”¨ <code>referenceEnhancer</code>ã€‚</p> <p><code>referenceEnhancer</code> ç¦ç”¨è‡ªåŠ¨çš„ <code>observable</code> è½¬æ¢ï¼Œåªæ˜¯åˆ›å»ºä¸€ä¸ª <code>observable</code> å¼•ç”¨ã€‚</p> <p><img src="/mobx-source-analysis/assets/img/shallowBox.99003330.png" alt="img"></p> <p><img src="/mobx-source-analysis/assets/img/shallowBox-result.69630a91.png" alt="img"></p> <p>ç›¸åçš„ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨ <code>observable.box</code>ï¼Œå¹¶ç»™å…¶ä¼ å…¥ <code>{ deep: true }</code>ã€‚</p> <p><img src="/mobx-source-analysis/assets/img/box-result.a9188ece.png" alt="img"></p> <p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>value</code> è¿™æ—¶å·²ç»æ˜¯ <code>ObservableValue</code> çš„å®ä¾‹ã€‚</p> <p>æ‰“å¼€ <code>types/observablevalue.ts</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å‘å¤–ç•Œæš´éœ² <code>ObservableValue</code> ç±»å’Œ <code>isObservableValue</code> æ–¹æ³•ã€‚</p> <h2 id="observablevalue"><a href="#observablevalue" aria-hidden="true" class="header-anchor">#</a> ObservableValue</h2> <h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" aria-hidden="true" class="header-anchor">#</a> æ„é€ å‡½æ•°</h3> <ol><li><code>ObservableValue</code> ç±»ç»§æ‰¿ <code>Atom</code> ç±»ã€‚</li> <li><code>ObservableValue</code> ç±»çš„æ„é€ å‡½æ•°æ¥æ”¶ 5 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º <code>value</code>ã€<code>enhancer</code>ã€<code>name</code>ã€<code>notifySpy</code> å’Œ <code>equals</code>ï¼Œå…¶ä¸­ <code>name</code> ä¸ <code>equals</code> å­˜åœ¨é»˜è®¤å€¼ã€‚<code>name</code>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ä¸€ä¸ª <code>id</code>ï¼Œ<code>equals</code> çš„é»˜è®¤å€¼ä¸º <code>comparer.default</code>ï¼Œ<code>comparer.default</code> ä¸»è¦ç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ã€‚</li> <li>è°ƒç”¨ä¸‹çˆ¶ç±» <code>Atom</code> æ„é€ å‡½æ•°ï¼Œå¹¶æŠŠ <code>value</code> å€¼è®¾ä¸ºä¼ é€’è¿›æ¥çš„ <code>enhancer</code> å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚</li> <li>åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬å’Œå…¨å±€çš„ç›‘å¬å™¨ <code>spy</code> æ•°é‡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å‘é€ä¸€ä¸ªäº‹ä»¶ã€‚</li> <li>ç±»ä¸­å®šä¹‰äº†è®¸å¤šæ–¹æ³•ï¼Œæ¯”å¦‚ <code>dehanceValue</code>ã€<code>set</code>ã€<code>prepareNewValue</code>ã€<code>setNewValue</code>ã€<code>get</code>ã€<code>intercept</code>ã€<code>observe</code>ã€<code>toJSON</code>ã€<code>toString</code> å’Œ <code>valueOf</code>ã€‚</li> <li>ç±»çš„åŸå‹ä¸Šä¼šé’ˆå¯¹å¯¹è±¡è½¬æˆåŸå§‹å€¼æ—¶ï¼Œè°ƒç”¨ <code>valueOf</code> æ–¹æ³•ã€‚</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ObservableValue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token function">primitiveSymbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ObservableValue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="æ–¹æ³•"><a href="#æ–¹æ³•" aria-hidden="true" class="header-anchor">#</a> æ–¹æ³•</h3> <p><code>ObservableValue</code> ç±» 8 ä¸ªå…¬å…±æ–¹æ³•ï¼Œ2 ä¸ªç§æœ‰æ–¹æ³•ã€‚</p> <p><img src="/mobx-source-analysis/assets/img/ObservableValue-method.de0c562f.png" alt="img"></p> <h4 id="observe"><a href="#observe" aria-hidden="true" class="header-anchor">#</a> observe</h4> <p>æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•° <code>listener</code> å’Œæ˜¯å¦ç«‹å³è°ƒç”¨ <code>fireImmediately</code>ã€‚å¦‚æœ <code>fireImmediately</code> ä¸º <code>true</code>ï¼Œåˆ™ç«‹å³è°ƒç”¨ <code>listener</code> å‡½æ•°ã€‚</p> <p>è°ƒç”¨ <code>registerListener</code> æ³¨å†Œç›‘å¬å™¨ï¼Œæ–¹æ³•å†…éƒ¨å¤§éƒ¨åˆ†ä¸ <code>registerInterceptor</code> å®ç°ç›¸åŒã€‚</p> <h4 id="intercept"><a href="#intercept" aria-hidden="true" class="header-anchor">#</a> intercept</h4> <p>ç”¨æ¥åœ¨ä»»ä½•å˜åŒ–åº”ç”¨å‰å°†å…¶æ‹¦æˆªã€‚</p> <p>æ–¹æ³•å†…éƒ¨è°ƒç”¨ <code>registerInterceptor</code>ï¼Œ<code>registerInterceptor</code> å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­å®ä¾‹ä¸Šæ˜¯å¦å­˜åœ¨ <code>interceptors</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™èµ‹ä¸º <code>[]</code>ï¼Œå¹¶æŠŠ <code>handler</code> å­˜å…¥ <code>interceptors</code>ã€‚æœ€åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä¸”è¯¥å‡½æ•°åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> registerInterceptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    interceptable<span class="token punctuation">:</span> IInterceptable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    handler<span class="token punctuation">:</span> IInterceptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Lambda <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> idx <span class="token operator">=</span> interceptors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> interceptors<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">:</span> Lambda</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Lambda <span class="token punctuation">{</span>
    <span class="token keyword">let</span> invoked <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invoked<span class="token punctuation">)</span> <span class="token keyword">return</span>
        invoked <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>func <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="get"><a href="#get" aria-hidden="true" class="header-anchor">#</a> get</h4> <p>è¿”å›å½“å‰å€¼ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// types/observablevalue.ts</span>
<span class="token keyword">public</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dehanceValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// core/atom.ts</span>
<span class="token keyword">public</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// core/observable.ts</span>
<span class="token keyword">function</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="reportobserved"><a href="#reportobserved" aria-hidden="true" class="header-anchor">#</a> reportObserved</h5> <ol><li><p>é¦–å…ˆè·å–å…¨å±€å¯¹è±¡ä¸­ <code>trackingDerivation</code>ï¼Œå¹¶èµ‹ç»™ <code>derivation</code>ã€‚ä»¥ <code>autorun</code> ä¸¾ä¾‹ï¼Œå½“ä½¿ç”¨ <code>autorun</code> çš„æ—¶å€™ï¼Œä¼šåœ¨å…¨å±€å¯¹è±¡ä¸­ <code>trackingDerivation</code> èµ‹å®ä¾‹åŒ–åçš„ <code>Reaction</code></p></li> <li><p>åˆ¤æ–­ <code>derivation</code> æ˜¯å¦æœ‰å€¼</p> <ul><li>æœ‰ï¼Œåˆ¤æ–­ <code>derivation</code> ä¸Š <code>runId</code> ä¸å®ä¾‹çš„ <code>lastAccessedBy</code> æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™ä»£è¡¨ä¾èµ–å·²ç»å»ºç«‹è¿‡ï¼Œä¸éœ€è¦å†æ¬¡åˆ›å»ºï¼Œæ²¡æœ‰åˆ™æŠŠ <code>derivation.runId</code> èµ‹ç»™ <code>lastAccessedBy</code>ï¼Œç„¶åæŠŠå®ä¾‹æ”¾å…¥ <code>derivation</code>ã€‚åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦å·²å¤„äºç›‘å¬çŠ¶æ€ï¼Œå¦‚æœå·²ç»å¤„äºï¼Œåˆ™è¿”å› <code>true</code>ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠŠå®ä¾‹ä¸Š <code>isBeingObserved</code> å€¼æ”¹ä¸º <code>true</code>ï¼Œå¹¶è°ƒç”¨å®ä¾‹çš„ <code>onBecomeObserved</code> æ–¹æ³•</li> <li>æ— ï¼Œä¸”å®ä¾‹ä¸Šæ—  <code>observers</code> ï¼Œå½“å‰å·²å¤„äºäº‹åŠ¡ä¸­ï¼Œåˆ™æŠŠå®ä¾‹æ¨å…¥å…¨å±€ä¸å†è¢«è§‚å¯Ÿé˜Ÿåˆ— <code>pendingUnobservations</code></li> <li>æ— ï¼Œä¸”å®ä¾‹ä¸Šæœ‰ <code>observers</code> æˆ–è€…å½“å‰æœªå¤„äºäº‹åŠ¡ä¸­ï¼Œç›´æ¥è¿”å› <code>false</code></li></ul></li></ol> <h4 id="set"><a href="#set" aria-hidden="true" class="header-anchor">#</a> set</h4> <p>æ›¿æ¢å½“å‰å­˜å‚¨çš„å€¼å¹¶é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ã€‚</p> <p><img src="/mobx-source-analysis/assets/img/ObservableValue-set.9b17e59b.png" alt="img"></p> <ol><li>æ–¹æ³•å†…éƒ¨é¦–å…ˆå–åˆ°ä»¥å‰çš„å€¼ <code>oldValue</code>ï¼Œç„¶åè°ƒç”¨ <code>prepareNewValue</code> æ–¹æ³•ç”Ÿæˆæ–°å€¼ <code>newValue</code>ã€‚</li> <li>åˆ¤æ–­ <code>newValue</code> æ˜¯å¦ç­‰äº <code>globalState.UNCHANGED</code>ï¼Œå¦‚æœç­‰äºä»€ä¹ˆéƒ½ä¸åšï¼Œå¦‚æœä¸ç­‰äºï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬å™¨ <code>spy</code>ï¼Œæœ‰åˆ™å‘é€ <code>spyReportStart</code> äº‹ä»¶ï¼Œæ²¡æœ‰åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚</li> <li>è°ƒç”¨ <code>setNewValue</code> æ–¹æ³•</li> <li>æœ‰ç›‘å¬å™¨åˆ™å‘é€ <code>spyReportEnd</code> äº‹ä»¶</li></ol> <h4 id="tojson"><a href="#tojson" aria-hidden="true" class="header-anchor">#</a> toJSON</h4> <p>è¿”å› <code>this.get()</code></p> <h4 id="setnewvalue"><a href="#setnewvalue" aria-hidden="true" class="header-anchor">#</a> setNewValue</h4> <ol><li>åŸæ¥çš„å€¼æ›´æ–°æˆä¼ å…¥çš„å€¼</li> <li>è°ƒç”¨ <code>reportChanged</code> å‡½æ•°</li> <li>åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬å™¨ <code>listener</code>ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨ <code>notifyListeners</code> æ–¹æ³•</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">public</span> <span class="token function">reportChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¼€å§‹å¤„ç†äº‹åŠ¡ï¼ŒæŠŠå…¨å±€ inBatch å€¼ + 1</span>
    <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// derivationã€reaction</span>
    <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç»“æŸå¤„ç†äº‹åŠ¡</span>
    <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="propagatechanged"><a href="#propagatechanged" aria-hidden="true" class="header-anchor">#</a> propagateChanged</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>åˆ¤æ–­å½“å‰ <code>observable.lowestObserverState</code> ä¸ <code>IDerivationState.STALE</code> æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚<code>IDerivationState.STALE</code> æ„å‘³ç€è‡ªä»æœ€åä¸€æ¬¡çš„è®¡ç®—å’Œè¡ç”Ÿä»¥æ¥ï¼Œå€¼å·²ç»å‘ç”Ÿæ”¹å˜ï¼Œä¸‹ä¸€æ¬¡éœ€è¦çš„æ—¶å€™éœ€è¦é‡æ–°è®¡ç®—</li> <li><code>IDerivationState.STALE</code> èµ‹å€¼ç»™ <code>observable.lowestObserverState</code></li> <li>å–åˆ° <code>observable.observers</code>ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éå†æ¯ä¸€é¡¹ï¼Œå¹¶åˆ¤æ–­æ¯ä¸€é¡¹çš„ <code>dependenciesState</code> ä¸ <code>IDerivationState.UP_TO_DATE</code> æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœä¸ç­‰ï¼Œåˆ™æŠŠæ¯ä¸€é¡¹çš„ <code>dependenciesState</code> å…¨éƒ½è®¾ç½®ä¸º <code>IDerivationState.STALE</code>ã€‚å¦åˆ™è°ƒç”¨ <code>onBecomeStale</code>ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ <code>reaction</code></li></ol> <h5 id="endbatch"><a href="#endbatch" aria-hidden="true" class="header-anchor">#</a> endBatch</h5> <p>åˆ¤æ–­ <code>--global.inBatch</code> æ˜¯å¦ç­‰äº <code>0</code>ï¼Œå¦‚æœæ˜¯åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚å¦åˆ™ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ <code>reaction</code>ã€‚è·å–å…¨å±€æ‰€æœ‰å¾…å–æ¶ˆè§‚å¯Ÿçš„åˆ—è¡¨ï¼ŒæŠŠæ¯ä¸€é¡¹ <code>isPendingUnobservation</code> éƒ½è®¾ç½®ä¸º <code>false</code>ã€‚å¦‚æœ <code>observable.observers.length</code> ä¸º <code>0</code>ï¼Œä¸” <code>observable</code> å¤„äºè§‚å¯ŸçŠ¶æ€ï¼Œåˆ™æ ‡è®° <code>observable</code> ä¸ºä¸å¯è§‚å¯Ÿã€‚å¦‚æœ <code>observable</code> ä¸º <code>ComputedValue</code> çš„å®ä¾‹ï¼Œåˆ™è°ƒç”¨ <code>observable.suspend</code>ï¼Œæœ€åæ¸…ç©ºå…¨å±€æ‰€æœ‰å¾…å–æ¶ˆè§‚å¯Ÿåˆ—è¡¨ã€‚</p> <h4 id="tostring"><a href="#tostring" aria-hidden="true" class="header-anchor">#</a> toString</h4> <p>è¿”å› <code>${this.name}[${this.value}]</code></p> <h4 id="valueof"><a href="#valueof" aria-hidden="true" class="header-anchor">#</a> valueOf</h4> <p>è¿”å› <code>toPrimitive(this.get())</code></p> <h4 id="dehancevalue"><a href="#dehancevalue" aria-hidden="true" class="header-anchor">#</a> dehanceValue</h4> <p>å¦‚æœæœ‰ <code>dehancer</code>ï¼Œåˆ™è¿”å›è°ƒç”¨ <code>dehancer</code> æ–¹æ³•åçš„å€¼ï¼Œå¦åˆ™ç›´æ¥è¿”å›å€¼</p> <h4 id="preparenewvalue"><a href="#preparenewvalue" aria-hidden="true" class="header-anchor">#</a> prepareNewValue</h4> <p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ–¹æ³•å†…éƒ¨ä¼šé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰æ‹¦æˆªå™¨ <code>interceptor</code>ã€‚</p> <ul><li><p>å¦‚æœæœ‰åˆ™ä¼šä¾æ¬¡è°ƒç”¨æ‹¦æˆªå™¨æ–¹æ³•ï¼Œå¹¶åˆ¤æ–­æ‹¦æˆªå™¨æ˜¯å¦è¿”å›å¯¹è±¡æˆ– nothingï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ¥é”™ï¼›å¦‚æœæ˜¯ nothingï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸‹é¢çš„æ‹¦æˆªå™¨ä¸å†è°ƒç”¨ï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™ç»§ç»­è°ƒç”¨æ¥ä¸‹æ¥çš„æ‹¦æˆªå™¨ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> interceptChange<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    interceptable<span class="token punctuation">:</span> IInterceptable<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    change<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevU <span class="token operator">=</span> <span class="token function">untrackedStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> interceptors <span class="token operator">=</span> interceptable<span class="token punctuation">.</span>interceptors
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                change <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span>
                <span class="token function">invariant</span><span class="token punctuation">(</span>
                    <span class="token operator">!</span>change <span class="token operator">||</span> <span class="token punctuation">(</span>change <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                    <span class="token string">&quot;Intercept handlers should return nothing or a change object&quot;</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>change<span class="token punctuation">)</span> <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> change
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">untrackedEnd</span><span class="token punctuation">(</span>prevU<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å¦‚æœè¿”å›çš„ <code>change</code> ä¸º nothingï¼Œåˆ™ç›´æ¥è¿”å› <code>globalState.UNCHANGED</code>ï¼Œå¦åˆ™å– <code>change.newValue</code> ä½œä¸ºæ–°å€¼ã€‚æ¥ä¸‹æ¥æ–¹æ³•å’Œæ²¡æœ‰æ‹¦æˆªå™¨èµ°çš„é€»è¾‘ä¸€è‡´ã€‚</p></li> <li><p>å¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨ï¼Œåˆ™è°ƒç”¨ <code>enhancer</code> æ–¹æ³•ç”Ÿæˆæ–°å€¼ï¼Œæœ€ååˆ¤æ–­æ—§å€¼ä¸æ–°å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰è¿”å› <code>globalState.UNCHANGED</code>ï¼Œå¦åˆ™è¿”å›æ–°å€¼ã€‚</p></li></ul> <h2 id="isobservablevalue"><a href="#isobservablevalue" aria-hidden="true" class="header-anchor">#</a> isObservableValue</h2> <p><code>isObservableValue</code> å‡½æ•°æ˜¯ <code>createInstanceofPredicate</code> å‡½æ•°è¿”å›å€¼ã€‚</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> isObservableValue <span class="token operator">=</span> <span class="token function">createInstanceofPredicate</span><span class="token punctuation">(</span><span class="token string">&quot;ObservableValue&quot;</span><span class="token punctuation">,</span> ObservableValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="ç»“å°¾è¯­"><a href="#ç»“å°¾è¯­" aria-hidden="true" class="header-anchor">#</a> ç»“å°¾è¯­</h2> <p><code>mox</code> æºç é˜…è¯»èµ·æ¥ï¼Œå¾ˆéš¾ç†è§£ï¼Œéœ€è¦ç»†ç»†å“å°ã€‚å¦‚æœè§‰å¾—å†™å¾—å¥½ä¸é”™ï¼Œè¿˜è¯·é¼“åŠ±ä¸‹ï¼Œç‚¹ä¸ªğŸ‘ã€‚</p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">æœ€åæ›´æ–°:</span> <span class="time">8/25/2019, 9:32:02 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/mobx-source-analysis/assets/js/app.a19a3fb9.js" defer></script><script src="/mobx-source-analysis/assets/js/2.16839f28.js" defer></script><script src="/mobx-source-analysis/assets/js/3.dda6df1c.js" defer></script><script src="/mobx-source-analysis/assets/js/6.0baf6d73.js" defer></script>
  </body>
</html>
