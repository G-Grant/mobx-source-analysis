<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mobx 源码分析 - shallowBox、box、ObservableValue | Mobx 源码分析</title>
    <meta name="description" content="不积跬步，无以至千里；不积小流，无以成江海。">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="shortcut icon" href="/mobx-source-analysis/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/mobx-source-analysis/favicon.ico" type="image/x-icon">
    
    <link rel="preload" href="/mobx-source-analysis/assets/css/0.styles.96e00fc3.css" as="style"><link rel="preload" href="/mobx-source-analysis/assets/js/app.a19a3fb9.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/2.16839f28.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/3.dda6df1c.js" as="script"><link rel="preload" href="/mobx-source-analysis/assets/js/6.0baf6d73.js" as="script"><link rel="prefetch" href="/mobx-source-analysis/assets/js/10.1f8192ef.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/11.1aef4ea1.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/12.619c319d.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/13.bce74719.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/14.d973291b.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/4.0b1e5714.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/5.5824d97a.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/7.16061ce9.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/8.35386181.js"><link rel="prefetch" href="/mobx-source-analysis/assets/js/9.8a72fd31.js">
    <link rel="stylesheet" href="/mobx-source-analysis/assets/css/0.styles.96e00fc3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mobx-source-analysis/" class="home-link router-link-active"><!----> <span class="site-name">Mobx 源码分析</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mobx-source-analysis/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://g-grant.github.io/Note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/G-Grant" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mobx-source-analysis/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://g-grant.github.io/Note/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/G-Grant" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mobx 源码分析 - shallowBox、box、ObservableValue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mobx-source-analysis/20190822.html#shallowbox、box" class="sidebar-link">shallowBox、box</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mobx-source-analysis/20190822.html#observablevalue" class="sidebar-link">ObservableValue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mobx-source-analysis/20190822.html#构造函数" class="sidebar-link">构造函数</a></li><li class="sidebar-sub-header"><a href="/mobx-source-analysis/20190822.html#方法" class="sidebar-link">方法</a></li></ul></li><li><a href="/mobx-source-analysis/20190822.html#isobservablevalue" class="sidebar-link">isObservableValue</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mobx-source-analysis/20190822.html#结尾语" class="sidebar-link">结尾语</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mobx-源码分析-shallowbox、box、observablevalue"><a href="#mobx-源码分析-shallowbox、box、observablevalue" aria-hidden="true" class="header-anchor">#</a> Mobx 源码分析 - shallowBox、box、ObservableValue</h1> <p><a href="/mobx-source-analysis/20190822.html" class="router-link-exact-active router-link-active">上文</a>提到，<code>observable</code> 上绑定了 13 个方法。此篇文章会重点讲解 <code>shallowBox</code> 和 <code>box</code>。</p> <h2 id="shallowbox、box"><a href="#shallowbox、box" aria-hidden="true" class="header-anchor">#</a> shallowBox、box</h2> <p>当调用 <code>observable.shallowBox</code> 时，<code>mobx</code> 会给出废弃警告，并帮你转换成 <code>observable.box</code>，只是在转换的时候，会给 <code>observable.box</code> 传入第二个参数 <code>{ name, deep: false }</code>，这个参数的作用便是告诉 <code>observable.box</code> 在实例化 <code>ObservableValue</code> 时，使用 <code>referenceEnhancer</code>。</p> <p><code>referenceEnhancer</code> 禁用自动的 <code>observable</code> 转换，只是创建一个 <code>observable</code> 引用。</p> <p><img src="/mobx-source-analysis/assets/img/shallowBox.99003330.png" alt="img"></p> <p><img src="/mobx-source-analysis/assets/img/shallowBox-result.69630a91.png" alt="img"></p> <p>相反的，如果我们调用 <code>observable.box</code>，并给其传入 <code>{ deep: true }</code>。</p> <p><img src="/mobx-source-analysis/assets/img/box-result.a9188ece.png" alt="img"></p> <p>可以看到，<code>value</code> 这时已经是 <code>ObservableValue</code> 的实例。</p> <p>打开 <code>types/observablevalue.ts</code> 文件，该文件向外界暴露 <code>ObservableValue</code> 类和 <code>isObservableValue</code> 方法。</p> <h2 id="observablevalue"><a href="#observablevalue" aria-hidden="true" class="header-anchor">#</a> ObservableValue</h2> <h3 id="构造函数"><a href="#构造函数" aria-hidden="true" class="header-anchor">#</a> 构造函数</h3> <ol><li><code>ObservableValue</code> 类继承 <code>Atom</code> 类。</li> <li><code>ObservableValue</code> 类的构造函数接收 5 个参数，分别为 <code>value</code>、<code>enhancer</code>、<code>name</code>、<code>notifySpy</code> 和 <code>equals</code>，其中 <code>name</code> 与 <code>equals</code> 存在默认值。<code>name</code>没什么好说的，就是一个 <code>id</code>，<code>equals</code> 的默认值为 <code>comparer.default</code>，<code>comparer.default</code> 主要用来判断两个值是否相等。</li> <li>调用下父类 <code>Atom</code> 构造函数，并把 <code>value</code> 值设为传递进来的 <code>enhancer</code> 函数执行的结果。</li> <li>判断是否需要监听和全局的监听器 <code>spy</code> 数量，如果有，则发送一个事件。</li> <li>类中定义了许多方法，比如 <code>dehanceValue</code>、<code>set</code>、<code>prepareNewValue</code>、<code>setNewValue</code>、<code>get</code>、<code>intercept</code>、<code>observe</code>、<code>toJSON</code>、<code>toString</code> 和 <code>valueOf</code>。</li> <li>类的原型上会针对对象转成原始值时，调用 <code>valueOf</code> 方法。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ObservableValue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token function">primitiveSymbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ObservableValue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="方法"><a href="#方法" aria-hidden="true" class="header-anchor">#</a> 方法</h3> <p><code>ObservableValue</code> 类 8 个公共方法，2 个私有方法。</p> <p><img src="/mobx-source-analysis/assets/img/ObservableValue-method.de0c562f.png" alt="img"></p> <h4 id="observe"><a href="#observe" aria-hidden="true" class="header-anchor">#</a> observe</h4> <p>接收一个回调函数 <code>listener</code> 和是否立即调用 <code>fireImmediately</code>。如果 <code>fireImmediately</code> 为 <code>true</code>，则立即调用 <code>listener</code> 函数。</p> <p>调用 <code>registerListener</code> 注册监听器，方法内部大部分与 <code>registerInterceptor</code> 实现相同。</p> <h4 id="intercept"><a href="#intercept" aria-hidden="true" class="header-anchor">#</a> intercept</h4> <p>用来在任何变化应用前将其拦截。</p> <p>方法内部调用 <code>registerInterceptor</code>，<code>registerInterceptor</code> 函数内部会判断实例上是否存在 <code>interceptors</code>，如果不存在，则赋为 <code>[]</code>，并把 <code>handler</code> 存入 <code>interceptors</code>。最后返回一个函数，且该函数只能被调用一次。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> registerInterceptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    interceptable<span class="token punctuation">:</span> IInterceptable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    handler<span class="token punctuation">:</span> IInterceptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Lambda <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> idx <span class="token operator">=</span> interceptors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> interceptors<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">:</span> Lambda</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Lambda <span class="token punctuation">{</span>
    <span class="token keyword">let</span> invoked <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invoked<span class="token punctuation">)</span> <span class="token keyword">return</span>
        invoked <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>func <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="get"><a href="#get" aria-hidden="true" class="header-anchor">#</a> get</h4> <p>返回当前值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// types/observablevalue.ts</span>
<span class="token keyword">public</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dehanceValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// core/atom.ts</span>
<span class="token keyword">public</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// core/observable.ts</span>
<span class="token keyword">function</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="reportobserved"><a href="#reportobserved" aria-hidden="true" class="header-anchor">#</a> reportObserved</h5> <ol><li><p>首先获取全局对象中 <code>trackingDerivation</code>，并赋给 <code>derivation</code>。以 <code>autorun</code> 举例，当使用 <code>autorun</code> 的时候，会在全局对象中 <code>trackingDerivation</code> 赋实例化后的 <code>Reaction</code></p></li> <li><p>判断 <code>derivation</code> 是否有值</p> <ul><li>有，判断 <code>derivation</code> 上 <code>runId</code> 与实例的 <code>lastAccessedBy</code> 是否相等，相等则代表依赖已经建立过，不需要再次创建，没有则把 <code>derivation.runId</code> 赋给 <code>lastAccessedBy</code>，然后把实例放入 <code>derivation</code>。判断当前实例是否已处于监听状态，如果已经处于，则返回 <code>true</code>，如果不是则把实例上 <code>isBeingObserved</code> 值改为 <code>true</code>，并调用实例的 <code>onBecomeObserved</code> 方法</li> <li>无，且实例上无 <code>observers</code> ，当前已处于事务中，则把实例推入全局不再被观察队列 <code>pendingUnobservations</code></li> <li>无，且实例上有 <code>observers</code> 或者当前未处于事务中，直接返回 <code>false</code></li></ul></li></ol> <h4 id="set"><a href="#set" aria-hidden="true" class="header-anchor">#</a> set</h4> <p>替换当前存储的值并通知所有观察者。</p> <p><img src="/mobx-source-analysis/assets/img/ObservableValue-set.9b17e59b.png" alt="img"></p> <ol><li>方法内部首先取到以前的值 <code>oldValue</code>，然后调用 <code>prepareNewValue</code> 方法生成新值 <code>newValue</code>。</li> <li>判断 <code>newValue</code> 是否等于 <code>globalState.UNCHANGED</code>，如果等于什么都不做，如果不等于，则判断是否有监听器 <code>spy</code>，有则发送 <code>spyReportStart</code> 事件，没有则什么都不做。</li> <li>调用 <code>setNewValue</code> 方法</li> <li>有监听器则发送 <code>spyReportEnd</code> 事件</li></ol> <h4 id="tojson"><a href="#tojson" aria-hidden="true" class="header-anchor">#</a> toJSON</h4> <p>返回 <code>this.get()</code></p> <h4 id="setnewvalue"><a href="#setnewvalue" aria-hidden="true" class="header-anchor">#</a> setNewValue</h4> <ol><li>原来的值更新成传入的值</li> <li>调用 <code>reportChanged</code> 函数</li> <li>判断是否有监听器 <code>listener</code>，如果有，调用 <code>notifyListeners</code> 方法</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">public</span> <span class="token function">reportChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开始处理事务，把全局 inBatch 值 + 1</span>
    <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// derivation、reaction</span>
    <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结束处理事务</span>
    <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="propagatechanged"><a href="#propagatechanged" aria-hidden="true" class="header-anchor">#</a> propagateChanged</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>判断当前 <code>observable.lowestObserverState</code> 与 <code>IDerivationState.STALE</code> 是否相等，相等则什么也不做。<code>IDerivationState.STALE</code> 意味着自从最后一次的计算和衍生以来，值已经发生改变，下一次需要的时候需要重新计算</li> <li><code>IDerivationState.STALE</code> 赋值给 <code>observable.lowestObserverState</code></li> <li>取到 <code>observable.observers</code>，如果有，则遍历每一项，并判断每一项的 <code>dependenciesState</code> 与 <code>IDerivationState.UP_TO_DATE</code> 是否相等。如果不等，则把每一项的 <code>dependenciesState</code> 全都设置为 <code>IDerivationState.STALE</code>。否则调用 <code>onBecomeStale</code>，执行所有的 <code>reaction</code></li></ol> <h5 id="endbatch"><a href="#endbatch" aria-hidden="true" class="header-anchor">#</a> endBatch</h5> <p>判断 <code>--global.inBatch</code> 是否等于 <code>0</code>，如果是则什么也不做。否则，执行所有的 <code>reaction</code>。获取全局所有待取消观察的列表，把每一项 <code>isPendingUnobservation</code> 都设置为 <code>false</code>。如果 <code>observable.observers.length</code> 为 <code>0</code>，且 <code>observable</code> 处于观察状态，则标记 <code>observable</code> 为不可观察。如果 <code>observable</code> 为 <code>ComputedValue</code> 的实例，则调用 <code>observable.suspend</code>，最后清空全局所有待取消观察列表。</p> <h4 id="tostring"><a href="#tostring" aria-hidden="true" class="header-anchor">#</a> toString</h4> <p>返回 <code>${this.name}[${this.value}]</code></p> <h4 id="valueof"><a href="#valueof" aria-hidden="true" class="header-anchor">#</a> valueOf</h4> <p>返回 <code>toPrimitive(this.get())</code></p> <h4 id="dehancevalue"><a href="#dehancevalue" aria-hidden="true" class="header-anchor">#</a> dehanceValue</h4> <p>如果有 <code>dehancer</code>，则返回调用 <code>dehancer</code> 方法后的值，否则直接返回值</p> <h4 id="preparenewvalue"><a href="#preparenewvalue" aria-hidden="true" class="header-anchor">#</a> prepareNewValue</h4> <p>值得一提的是，方法内部会首先判断是否有拦截器 <code>interceptor</code>。</p> <ul><li><p>如果有则会依次调用拦截器方法，并判断拦截器是否返回对象或 nothing，如果不是则报错；如果是 nothing，则直接返回，下面的拦截器不再调用；如果是对象，则继续调用接下来的拦截器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> interceptChange<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    interceptable<span class="token punctuation">:</span> IInterceptable<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    change<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevU <span class="token operator">=</span> <span class="token function">untrackedStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> interceptors <span class="token operator">=</span> interceptable<span class="token punctuation">.</span>interceptors
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                change <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span>
                <span class="token function">invariant</span><span class="token punctuation">(</span>
                    <span class="token operator">!</span>change <span class="token operator">||</span> <span class="token punctuation">(</span>change <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                    <span class="token string">&quot;Intercept handlers should return nothing or a change object&quot;</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>change<span class="token punctuation">)</span> <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> change
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">untrackedEnd</span><span class="token punctuation">(</span>prevU<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>如果返回的 <code>change</code> 为 nothing，则直接返回 <code>globalState.UNCHANGED</code>，否则取 <code>change.newValue</code> 作为新值。接下来方法和没有拦截器走的逻辑一致。</p></li> <li><p>如果没有拦截器，则调用 <code>enhancer</code> 方法生成新值，最后判断旧值与新值是否相等，如果相等返回 <code>globalState.UNCHANGED</code>，否则返回新值。</p></li></ul> <h2 id="isobservablevalue"><a href="#isobservablevalue" aria-hidden="true" class="header-anchor">#</a> isObservableValue</h2> <p><code>isObservableValue</code> 函数是 <code>createInstanceofPredicate</code> 函数返回值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> isObservableValue <span class="token operator">=</span> <span class="token function">createInstanceofPredicate</span><span class="token punctuation">(</span><span class="token string">&quot;ObservableValue&quot;</span><span class="token punctuation">,</span> ObservableValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="结尾语"><a href="#结尾语" aria-hidden="true" class="header-anchor">#</a> 结尾语</h2> <p><code>mox</code> 源码阅读起来，很难理解，需要细细品尝。如果觉得写得好不错，还请鼓励下，点个👍。</p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">8/25/2019, 9:32:02 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/mobx-source-analysis/assets/js/app.a19a3fb9.js" defer></script><script src="/mobx-source-analysis/assets/js/2.16839f28.js" defer></script><script src="/mobx-source-analysis/assets/js/3.dda6df1c.js" defer></script><script src="/mobx-source-analysis/assets/js/6.0baf6d73.js" defer></script>
  </body>
</html>
