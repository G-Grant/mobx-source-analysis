# Mobx æºç åˆ†æ - shallowBoxã€boxã€ObservableValue

[ä¸Šæ–‡](./20190822.md)æåˆ°ï¼Œ`observable` ä¸Šç»‘å®šäº† 13 ä¸ªæ–¹æ³•ã€‚æ­¤ç¯‡æ–‡ç« ä¼šé‡ç‚¹è®²è§£ `shallowBox` å’Œ `box`ã€‚

## shallowBoxã€box

å½“è°ƒç”¨ `observable.shallowBox` æ—¶ï¼Œ`mobx` ä¼šç»™å‡ºåºŸå¼ƒè­¦å‘Šï¼Œå¹¶å¸®ä½ è½¬æ¢æˆ `observable.box`ï¼Œåªæ˜¯åœ¨è½¬æ¢çš„æ—¶å€™ï¼Œä¼šç»™ `observable.box` ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•° `{ name, deep: false }`ï¼Œè¿™ä¸ªå‚æ•°çš„ä½œç”¨ä¾¿æ˜¯å‘Šè¯‰ `observable.box` åœ¨å®ä¾‹åŒ– `ObservableValue` æ—¶ï¼Œä½¿ç”¨ `referenceEnhancer`ã€‚

`referenceEnhancer` ç¦ç”¨è‡ªåŠ¨çš„ `observable` è½¬æ¢ï¼Œåªæ˜¯åˆ›å»ºä¸€ä¸ª `observable` å¼•ç”¨ã€‚

![img](../img/shallowBox.png)

![img](../img/shallowBox-result.png)

ç›¸åçš„ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨ `observable.box`ï¼Œå¹¶ç»™å…¶ä¼ å…¥ `{ deep: true }`ã€‚

![img](../img/box-result.png)

å¯ä»¥çœ‹åˆ°ï¼Œ`value` è¿™æ—¶å·²ç»æ˜¯ `ObservableValue` çš„å®ä¾‹ã€‚

æ‰“å¼€ `types/observablevalue.ts` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å‘å¤–ç•Œæš´éœ² `ObservableValue` ç±»å’Œ `isObservableValue` æ–¹æ³•ã€‚

## ObservableValue

### æ„é€ å‡½æ•°

1. `ObservableValue` ç±»ç»§æ‰¿ `Atom` ç±»ã€‚
2. `ObservableValue` ç±»çš„æ„é€ å‡½æ•°æ¥æ”¶ 5 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º `value`ã€`enhancer`ã€`name`ã€`notifySpy` å’Œ `equals`ï¼Œå…¶ä¸­ `name` ä¸ `equals` å­˜åœ¨é»˜è®¤å€¼ã€‚`name`æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ä¸€ä¸ª `id`ï¼Œ`equals` çš„é»˜è®¤å€¼ä¸º `comparer.default`ï¼Œ`comparer.default` ä¸»è¦ç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ã€‚
3. è°ƒç”¨ä¸‹çˆ¶ç±» `Atom` æ„é€ å‡½æ•°ï¼Œå¹¶æŠŠ `value` å€¼è®¾ä¸ºä¼ é€’è¿›æ¥çš„ `enhancer` å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚
4. åˆ¤æ–­æ˜¯å¦éœ€è¦ç›‘å¬å’Œå…¨å±€çš„ç›‘å¬å™¨ `spy` æ•°é‡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å‘é€ä¸€ä¸ªäº‹ä»¶ã€‚
5. ç±»ä¸­å®šä¹‰äº†è®¸å¤šæ–¹æ³•ï¼Œæ¯”å¦‚ `dehanceValue`ã€`set`ã€`prepareNewValue`ã€`setNewValue`ã€`get`ã€`intercept`ã€`observe`ã€`toJSON`ã€`toString` å’Œ `valueOf`ã€‚
6. ç±»çš„åŸå‹ä¸Šä¼šé’ˆå¯¹å¯¹è±¡è½¬æˆåŸå§‹å€¼æ—¶ï¼Œè°ƒç”¨ `valueOf` æ–¹æ³•ã€‚

```js
ObservableValue.prototype[primitiveSymbol()] = ObservableValue.prototype.valueOf
```

### æ–¹æ³•

`ObservableValue` ç±» 8 ä¸ªå…¬å…±æ–¹æ³•ï¼Œ2 ä¸ªç§æœ‰æ–¹æ³•ã€‚

![img](../img/ObservableValue-method.png)

#### observe

æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•° `listener` å’Œæ˜¯å¦ç«‹å³è°ƒç”¨ `fireImmediately`ã€‚å¦‚æœ `fireImmediately` ä¸º `true`ï¼Œåˆ™ç«‹å³è°ƒç”¨ `listener` å‡½æ•°ã€‚

è°ƒç”¨ `registerListener` æ³¨å†Œç›‘å¬å™¨ï¼Œæ–¹æ³•å†…éƒ¨å¤§éƒ¨åˆ†ä¸ `registerInterceptor` å®ç°ç›¸åŒã€‚

#### intercept

ç”¨æ¥åœ¨ä»»ä½•å˜åŒ–åº”ç”¨å‰å°†å…¶æ‹¦æˆªã€‚

æ–¹æ³•å†…éƒ¨è°ƒç”¨ `registerInterceptor`ï¼Œ`registerInterceptor` å‡½æ•°å†…éƒ¨ä¼šåˆ¤æ–­å®ä¾‹ä¸Šæ˜¯å¦å­˜åœ¨ `interceptors`ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™èµ‹ä¸º `[]`ï¼Œå¹¶æŠŠ `handler` å­˜å…¥ `interceptors`ã€‚æœ€åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä¸”è¯¥å‡½æ•°åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚

```js
export function registerInterceptor<T>(
    interceptable: IInterceptable<T>,
    handler: IInterceptor<T>
): Lambda {
    ...
    return once(() => {
        const idx = interceptors.indexOf(handler)
        if (idx !== -1) interceptors.splice(idx, 1)
    })
}
export function once(func: Lambda): Lambda {
    let invoked = false
    return function() {
        if (invoked) return
        invoked = true
        return (func as any).apply(this, arguments)
    }
}
```

#### get

è¿”å›å½“å‰å€¼ã€‚

```js
// types/observablevalue.ts
public get(): T {
    this.reportObserved()
    return this.dehanceValue(this.value)
}
// core/atom.ts
public reportObserved(): boolean {
    return reportObserved(this)
}
// core/observable.ts
function reportObserved(observable){}
```

##### reportObserved

1. é¦–å…ˆè·å–å…¨å±€å¯¹è±¡ä¸­ `trackingDerivation`ï¼Œå¹¶èµ‹ç»™ `derivation`ã€‚ä»¥ `autorun` ä¸¾ä¾‹ï¼Œå½“ä½¿ç”¨ `autorun` çš„æ—¶å€™ï¼Œä¼šåœ¨å…¨å±€å¯¹è±¡ä¸­ `trackingDerivation` èµ‹å®ä¾‹åŒ–åçš„ `Reaction`
2. åˆ¤æ–­ `derivation` æ˜¯å¦æœ‰å€¼

    - æœ‰ï¼Œåˆ¤æ–­ `derivation` ä¸Š `runId` ä¸å®ä¾‹çš„ `lastAccessedBy` æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™ä»£è¡¨ä¾èµ–å·²ç»å»ºç«‹è¿‡ï¼Œä¸éœ€è¦å†æ¬¡åˆ›å»ºï¼Œæ²¡æœ‰åˆ™æŠŠ `derivation.runId` èµ‹ç»™ `lastAccessedBy`ï¼Œç„¶åæŠŠå®ä¾‹æ”¾å…¥ `derivation`ã€‚åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦å·²å¤„äºç›‘å¬çŠ¶æ€ï¼Œå¦‚æœå·²ç»å¤„äºï¼Œåˆ™è¿”å› `true`ï¼Œå¦‚æœä¸æ˜¯åˆ™æŠŠå®ä¾‹ä¸Š `isBeingObserved` å€¼æ”¹ä¸º `true`ï¼Œå¹¶è°ƒç”¨å®ä¾‹çš„ `onBecomeObserved` æ–¹æ³•
    - æ— ï¼Œä¸”å®ä¾‹ä¸Šæ—  `observers` ï¼Œå½“å‰å·²å¤„äºäº‹åŠ¡ä¸­ï¼Œåˆ™æŠŠå®ä¾‹æ¨å…¥å…¨å±€ä¸å†è¢«è§‚å¯Ÿé˜Ÿåˆ— `pendingUnobservations`
    - æ— ï¼Œä¸”å®ä¾‹ä¸Šæœ‰ `observers` æˆ–è€…å½“å‰æœªå¤„äºäº‹åŠ¡ä¸­ï¼Œç›´æ¥è¿”å› `false`

#### set

æ›¿æ¢å½“å‰å­˜å‚¨çš„å€¼å¹¶é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ã€‚

![img](../img/ObservableValue-set.png)

1. æ–¹æ³•å†…éƒ¨é¦–å…ˆå–åˆ°ä»¥å‰çš„å€¼ `oldValue`ï¼Œç„¶åè°ƒç”¨ `prepareNewValue` æ–¹æ³•ç”Ÿæˆæ–°å€¼ `newValue`ã€‚
2. åˆ¤æ–­ `newValue` æ˜¯å¦ç­‰äº `globalState.UNCHANGED`ï¼Œå¦‚æœç­‰äºä»€ä¹ˆéƒ½ä¸åšï¼Œå¦‚æœä¸ç­‰äºï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬å™¨ `spy`ï¼Œæœ‰åˆ™å‘é€ `spyReportStart` äº‹ä»¶ï¼Œæ²¡æœ‰åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚
3. è°ƒç”¨ `setNewValue` æ–¹æ³•
4. æœ‰ç›‘å¬å™¨åˆ™å‘é€ `spyReportEnd` äº‹ä»¶

#### toJSON

è¿”å› `this.get()`

#### setNewValue

1. åŸæ¥çš„å€¼æ›´æ–°æˆä¼ å…¥çš„å€¼
2. è°ƒç”¨ `reportChanged` å‡½æ•°
3. åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬å™¨ `listener`ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨ `notifyListeners` æ–¹æ³•

```js
public reportChanged() {
    // å¼€å§‹å¤„ç†äº‹åŠ¡ï¼ŒæŠŠå…¨å±€ inBatch å€¼ + 1
    startBatch();
    // derivationã€reaction
    propagateChanged(this);
    // ç»“æŸå¤„ç†äº‹åŠ¡
    endBatch();
}
```

##### propagateChanged

```js
function propagateChanged(observable) {}
```

1. åˆ¤æ–­å½“å‰ `observable.lowestObserverState` ä¸ `IDerivationState.STALE` æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚`IDerivationState.STALE` æ„å‘³ç€è‡ªä»æœ€åä¸€æ¬¡çš„è®¡ç®—å’Œè¡ç”Ÿä»¥æ¥ï¼Œå€¼å·²ç»å‘ç”Ÿæ”¹å˜ï¼Œä¸‹ä¸€æ¬¡éœ€è¦çš„æ—¶å€™éœ€è¦é‡æ–°è®¡ç®—
2. `IDerivationState.STALE` èµ‹å€¼ç»™ `observable.lowestObserverState`
3. å–åˆ° `observable.observers`ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éå†æ¯ä¸€é¡¹ï¼Œå¹¶åˆ¤æ–­æ¯ä¸€é¡¹çš„ `dependenciesState` ä¸ `IDerivationState.UP_TO_DATE` æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœä¸ç­‰ï¼Œåˆ™æŠŠæ¯ä¸€é¡¹çš„ `dependenciesState` å…¨éƒ½è®¾ç½®ä¸º `IDerivationState.STALE`ã€‚å¦åˆ™è°ƒç”¨ `onBecomeStale`ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ `reaction`

##### endBatch

åˆ¤æ–­ `--global.inBatch` æ˜¯å¦ç­‰äº `0`ï¼Œå¦‚æœæ˜¯åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚å¦åˆ™ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ `reaction`ã€‚è·å–å…¨å±€æ‰€æœ‰å¾…å–æ¶ˆè§‚å¯Ÿçš„åˆ—è¡¨ï¼ŒæŠŠæ¯ä¸€é¡¹ `isPendingUnobservation` éƒ½è®¾ç½®ä¸º `false`ã€‚å¦‚æœ `observable.observers.length` ä¸º `0`ï¼Œä¸” `observable` å¤„äºè§‚å¯ŸçŠ¶æ€ï¼Œåˆ™æ ‡è®° `observable` ä¸ºä¸å¯è§‚å¯Ÿã€‚å¦‚æœ `observable` ä¸º `ComputedValue` çš„å®ä¾‹ï¼Œåˆ™è°ƒç”¨ `observable.suspend`ï¼Œæœ€åæ¸…ç©ºå…¨å±€æ‰€æœ‰å¾…å–æ¶ˆè§‚å¯Ÿåˆ—è¡¨ã€‚

#### toString

è¿”å› `${this.name}[${this.value}]`

#### valueOf

è¿”å› `toPrimitive(this.get())`

#### dehanceValue

å¦‚æœæœ‰ `dehancer`ï¼Œåˆ™è¿”å›è°ƒç”¨ `dehancer` æ–¹æ³•åçš„å€¼ï¼Œå¦åˆ™ç›´æ¥è¿”å›å€¼

#### prepareNewValue

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ–¹æ³•å†…éƒ¨ä¼šé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰æ‹¦æˆªå™¨ `interceptor`ã€‚

- å¦‚æœæœ‰åˆ™ä¼šä¾æ¬¡è°ƒç”¨æ‹¦æˆªå™¨æ–¹æ³•ï¼Œå¹¶åˆ¤æ–­æ‹¦æˆªå™¨æ˜¯å¦è¿”å›å¯¹è±¡æˆ– nothingï¼Œå¦‚æœä¸æ˜¯åˆ™æŠ¥é”™ï¼›å¦‚æœæ˜¯ nothingï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸‹é¢çš„æ‹¦æˆªå™¨ä¸å†è°ƒç”¨ï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™ç»§ç»­è°ƒç”¨æ¥ä¸‹æ¥çš„æ‹¦æˆªå™¨ã€‚

    ```js
    export function interceptChange<T>(
        interceptable: IInterceptable<T | null>,
        change: T | null
    ): T | null {
        const prevU = untrackedStart()
        try {
            const interceptors = interceptable.interceptors
            if (interceptors)
                for (let i = 0, l = interceptors.length; i < l; i++) {
                    change = interceptors[i](change)
                    invariant(
                        !change || (change as any).type,
                        "Intercept handlers should return nothing or a change object"
                    )
                    if (!change) break
                }
            return change
        } finally {
            untrackedEnd(prevU)
        }
    }
    ```

    å¦‚æœè¿”å›çš„ `change` ä¸º nothingï¼Œåˆ™ç›´æ¥è¿”å› `globalState.UNCHANGED`ï¼Œå¦åˆ™å– `change.newValue` ä½œä¸ºæ–°å€¼ã€‚æ¥ä¸‹æ¥æ–¹æ³•å’Œæ²¡æœ‰æ‹¦æˆªå™¨èµ°çš„é€»è¾‘ä¸€è‡´ã€‚

- å¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨ï¼Œåˆ™è°ƒç”¨ `enhancer` æ–¹æ³•ç”Ÿæˆæ–°å€¼ï¼Œæœ€ååˆ¤æ–­æ—§å€¼ä¸æ–°å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰è¿”å› `globalState.UNCHANGED`ï¼Œå¦åˆ™è¿”å›æ–°å€¼ã€‚

## isObservableValue

`isObservableValue` å‡½æ•°æ˜¯ `createInstanceofPredicate` å‡½æ•°è¿”å›å€¼ã€‚

```js
var isObservableValue = createInstanceofPredicate("ObservableValue", ObservableValue);
```

## ç»“å°¾è¯­

`mox` æºç é˜…è¯»èµ·æ¥ï¼Œå¾ˆéš¾ç†è§£ï¼Œéœ€è¦ç»†ç»†å“å°ã€‚å¦‚æœè§‰å¾—å†™å¾—å¥½ä¸é”™ï¼Œè¿˜è¯·é¼“åŠ±ä¸‹ï¼Œç‚¹ä¸ªğŸ‘ã€‚
